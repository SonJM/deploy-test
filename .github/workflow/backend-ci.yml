# .github/workflows/ci.yml
name: Java CI - Test, Build, SAST, ECR

# ===========================================
# 1. 워크플로우 트리거 설정
# ===========================================
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

# ===========================================
# 2. 환경 변수 설정
# ===========================================
env:
  AWS_REGION: ap-northeast-2             # AWS 리전 (예: 서울)
  ECR_REPOSITORY: my-demo-app-repository # ECR 리포지토리 이름 (테라폼으로 생성한)

# ===========================================
# 3. 권한 설정
# ===========================================
permissions:
  contents: read              # 소스 코드 체크아웃에 필요
  id-token: write             # AWS OIDC 인증 (IAM Role)에 필요
  security-events: write      # Semgrep이 스캔 결과를 GitHub에 업로드하는 데 필요
  packages: write             # Docker 이미지 푸시(ECR)에 필요

# ===========================================
# 4. Job 정의
# ===========================================
jobs:
  ci-pipeline:
    name: CI Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ===========================================
      # CI 단계 (Test -> SAST -> Build)
      # ===========================================

      - name: Run Gradle Tests
        run: ./gradlew test

      - name: Run SAST with Semgrep
        uses: semgrep/semgrep-action@v2
        with:
          config: auto

      - name: Run Gradle Build
        run: ./gradlew build -x test

      # ===========================================
      # CD 단계 (ECR 배포 - main 브랜치 push 또는 수동 실행 시에만 동작)
      # ===========================================

      - name: Configure AWS Credentials
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::[YOUR_AWS_ACCOUNT_ID]:role/[YOUR_GITHUB_ACTIONS_ROLE_NAME]
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Define Image Tag
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        run: echo "IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and push Docker image to ECR
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          # 참고: ECR 리포지토리 URL은 login-ecr 스텝의 출력(registry)을 사용합니다.
          # 2개의 태그를 푸시합니다: 
          # 1. 고유 태그 (예: 12a3b4c) - 배포 제어 및 롤백에 사용
          # 2. latest 태그 - 최신 빌드 상태를 나타냄

      # 10단계: CI/CD 웹 앱으로 Webhook 전송 (선택 사항)
      # GitHub의 기본 Webhook 기능을 사용하는 것이 더 좋지만,
      # CI가 끝났음을 명시적으로 알리고 싶다면 이 단계를 활성화할 수 있습니다.
      # - name: Notify CI/CD Web App
      #   if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
      #   run: |
      #     curl -X POST -H "Content-Type: application/json" \
      #     -d '{"repository": "${{ github.repository }}", "status": "${{ job.status }}", "image_tag": "${{ env.IMAGE_TAG }}"}' \
      #     ${{ secrets.CI_WEBHOOK_URL }} # GitHub Secret에 웹 앱의 Webhook URL 저장 필요